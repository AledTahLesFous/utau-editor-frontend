<app-header [isLoggedIn]="isLoggedIn"></app-header>

<div class="relative w-full min-h-screen px-6 py-12 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 text-center overflow-hidden">

  <!-- Bouton fl√®che pour ouvrir/fermer le menu -->
  <div class="fixed top-1/3 right-0 z-50">
    <button
      (click)="editMode = !editMode"
      class="bg-yellow-500 dark:bg-yellow-600 text-white p-2 rounded-l-xl shadow-lg hover:scale-105 transition-all duration-300"
      [attr.aria-expanded]="editMode"
    >
      <span *ngIf="!editMode">‚ñ∂</span>
      <span *ngIf="editMode">‚óÄ</span>
    </button>
  </div>

  <!-- Menu lat√©ral -->
  <div
    class="fixed top-0 right-0 h-full w-80 bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl shadow-2xl transition-transform duration-300 z-40 flex flex-col p-6"
    [class.translate-x-full]="!editMode"
    [class.translate-x-0]="editMode"
  >
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Modifier Projet</h2>

    <div class="flex flex-col gap-4">
      <input
        type="text"
        [(ngModel)]="description"
        placeholder="Description"
        class="w-full p-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-white/70 dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400"
      />

      <div class="flex flex-col items-center gap-2">
        <label class="text-sm font-medium text-gray-900 dark:text-white">Tempo: {{ tempo || 120 }}</label>
        <input
          type="range"
          [(ngModel)]="tempo"
          min="40"
          max="300"
          step="10"
          class="w-full h-2 rounded-lg accent-emerald-400 cursor-pointer"
        />
      </div>
      <div class="mt-4">
  <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
  <select
    id="status"
    [(ngModel)]="status"
    name="status"
    class="border border-gray-300 rounded-lg w-full px-3 py-2"
  >
    <option *ngFor="let s of availableStatuses" [value]="s">
      {{ s | titlecase }}
    </option>
  </select>
</div>

<!-- Tags -->
<label class="text-sm font-medium text-gray-900 dark:text-white mt-4">Tags</label>
<select
  [(ngModel)]="selectedTags"
  (change)="onTagsSelectChange()"
  multiple
  size="4"
  class="w-full p-2 text-sm rounded-xl border border-gray-300 dark:border-gray-600 bg-white/70 dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400 cursor-pointer"
>
  <option *ngFor="let tag of tagsOptions" [ngValue]="tag.id">
    {{ tag.name }}
  </option>
</select>

<!-- Affichage des tags s√©lectionn√©s -->
<div class="flex flex-wrap gap-2 mt-3">
  <span *ngFor="let tagData of selectedTagsWithNames" class="px-3 py-1 bg-emerald-400 text-white text-xs rounded-full flex items-center gap-1">
    {{ tagData.name }}
    <button type="button" (click)="removeTag(tagData.id)" class="hover:opacity-70 font-bold">√ó</button>
  </span>
  <span *ngIf="selectedTags.length === 0" class="text-gray-500 text-xs italic">Aucun tag s√©lectionn√©</span>
</div>



      <div class="flex flex-col items-center gap-2">
        <label class="text-sm font-medium text-gray-900 dark:text-white">
          Duration: {{ duration }}
        </label>
        <input
          type="number"
          [(ngModel)]="durationEdit"
          placeholder="Duration (ms)"
          class="w-full p-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-white/70 dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400"
          (change)="updateTimelineWidth()"
        />

        <label>Changer l'image de couverture :</label>
<input type="file" (change)="onFileSelected($event)" class="form-control mb-2" />

<div *ngIf="existingCoverUrl">
  <p>Cover actuelle :</p>
  <img [src]="existingCoverUrl" style="width:160px; border-radius:8px;">
</div>

      </div>



      <div class="flex justify-center gap-3 mt-4">
        <button
          (click)="updateProject()"
          class="px-4 py-2 rounded-xl font-semibold shadow text-white hover:scale-105 transition-all duration-300 bg-gradient-to-r from-green-500 to-emerald-500 text-sm"
        >
          Enregistrer
        </button>

        <button
          (click)="cancelEdit()"
          class="px-4 py-2 rounded-xl font-semibold shadow text-white hover:scale-105 transition-all duration-300 bg-gradient-to-r from-red-500 to-pink-500 text-sm"
        >
          Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- Timeline Container -->
  <div
    class="mt-12 relative overflow-x-auto overflow-y-hidden border border-gray-300 rounded-lg shadow bg-gray-50 dark:bg-gray-900 "
    [style.height.px]="noteHeight * midiNotes.length"
    (click)="onTimelineClick($event)"
    (contextmenu)="$event.preventDefault()"
  >

<!-- Grid Background -->
<div
  class="absolute top-0 h-full pointer-events-none grid-background"
  [ngStyle]="{
    'background-size': gridSize + 'px ' + noteHeight + 'px',
    'left.px': labelsWidth,
    'width.px': timelineWidth - labelsWidth,
    'min-width.px': 1400
  }"
  [style.height.px]="noteHeight * midiNotes.length"
></div>


    <!-- Pitch Labels -->
<div class="absolute left-0 top-0 h-full z-10 pitch-labels"
     [style.width.px]="labelsWidth">
  <div *ngFor="let n of midiNotes; let i = index"
       [style.height.px]="noteHeight"
       class="text-xs text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700 flex items-center justify-start px-1">
    {{ n }}
  </div>
</div>

    <!-- Notes -->
    <div class="timeline relative"
     [style.height.px]="noteHeight * midiNotes.length"
     [style.marginLeft.px]="labelsWidth"
     [style.minWidth.px]="timelineWidth - labelsWidth">
      <app-note
        *ngFor="let note of notes"
        [note]="note"
        [left]="getNoteLeft(note.start_time)"
        [top]="getNoteY(note.pitch)"
        [width]="getNoteWidth(note.duration)"
        [height]="noteHeight"
        [zoomFactor]="zoomFactor"
        [highestPitch]="highestPitch"
        [moveMode]="moveMode"
        [deleteMode]="deleteMode"
        [timelineWidth]="timelineWidth"
        [timelineHeight]="noteHeight * midiNotes.length"
        [gridSize]="gridSize"
        [labelsWidth]="labelsWidth"

        (noteMoved)="onNoteMoved($event)"
        (noteResized)="onNoteResized($event)"
        (noteDeleted)="onNoteDeleted($event)"
      ></app-note>
    </div>
  </div>

  <!-- Choix du phoneme -->
  <div class="mt-6 flex flex-wrap items-center justify-center gap-4">
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-900 dark:text-white mb-1">Phon√®me</label>
      <select
        [(ngModel)]="selectedPhoneme"
        class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-white/70 dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400"
      >
        <option *ngFor="let phoneme of phonemes" [value]="phoneme.name">
          {{ phoneme.name }}
        </option>
      </select>
    </div>

    <button (click)="initializeAudio()" class="px-4 py-2 rounded-xl font-semibold shadow text-white hover:scale-105 transition-all duration-300 bg-blue-500 text-sm">
      üîπ Initialiser Audio
    </button>

    <button (click)="playAudio()" class="px-4 py-2 rounded-xl font-semibold shadow text-white hover:scale-105 transition-all duration-300 bg-green-500 text-sm">
      ‚ñ∂Ô∏è Play
    </button>

    <button (click)="toggleMoveMode()" [class.bg-gray-700]="moveMode" [class.bg-gray-500]="!moveMode"
      class="px-4 py-2 rounded-xl font-semibold shadow text-white hover:scale-105 transition-all duration-300">
      {{ moveMode ? 'MOVE MODE' : 'ADD MODE' }}
    </button>

    <button (click)="toggleDeleteMode()" [class.bg-red-700]="deleteMode" [class.bg-red-500]="!deleteMode"
      class="px-4 py-2 rounded-xl font-semibold shadow text-white hover:scale-105 transition-all duration-300">
      {{ deleteMode ? 'DELETE ON' : 'DELETE OFF' }}
    </button>

    <button (click)="clearNotes()" class="px-4 py-2 rounded-xl font-semibold shadow text-white bg-yellow-500 hover:scale-105 transition-all duration-300">
      CLEAR
    </button>
  </div>

</div>
